# Rust 源码阅读
先简单讲一下读 Rust 代码的顺序：从 crate 的大纲开始，先了解目标代码能干什么、怎么用；然后学习核心 trait，看看它支持哪些功能；之后再掌握主要的数据结构，开始写一些示例代码；最后围绕自己感兴趣的情景深入阅读。

## Step 1: 从大纲开始
[文档](https://docs.rs)  
看的顺序一般是：trait → struct → 函数 / 方法。因为这和我们写代码的思考方式非常类似：
- 先从需求的流程中敲定系统的行为，需要定义什么接口 trait；
- 再考虑系统有什么状态，定义了哪些数据结构 struct；
- 最后到实现细节，包括如何为数据结构实现 trait、数据结构自身有什么算法、如何把整个流程串起来等等。

## Step 2: 熟悉核心 trait 的行为
点进去看文档，主页面给了这个 trait 的定义和一个使用示例。  
看到这里，我们目前还没有深入源码，但已经可以学习到高手定义 trait 的一些思路：
- 定义好 trait 后，可以考虑一下标准库的数据结构，哪些可以实现这个 trait。
- 如果未来别人的某个类型 T ，实现了你的 trait，那他的 &T、&mut T、Box 等衍生类型，是否能够自动实现这个 trait。

## Step 3: 掌握主要的 struct
- 好的文档会给出数据结构的介绍、用法、使用时的注意事项，以及一些代码示例。
- 数据结构的代码往往会有一些注释，帮助你理解它的设计。
- 这个数据结构有哪些方法（Methods）、实现了哪些 trait（Trait implementations），以及 Auto trait / Blanket trait 的实现。

这也带给我们新的启发：
- 我们自己的数据结构，也应该尽可能实现需要的标准 trait，包括但不限于：AsRef、Borrow、Clone、Debug、Default、Deref、Drop、PartialEq/Eq、From、Hash、IntoIterator（如果是个集合类型）、PartialOrd/Ord 等。
- 标准库里的主要 trait 我们一定要好好学习，多多使用，最好能形成肌肉记忆。

看 Bytes 这个数据结构，扫一下它实现了哪些 trait，就基本能知道：
- 什么数据结构可以转化成 Bytes，也就是如何生成 Bytes 结构；
- Bytes 可以跟谁比较；
- Bytes 是否可以跨线程使用；
- 在使用中，Bytes 的行为和谁比较像（看 Deref trait）。

## Step 4: 深入研究实现逻辑
大部分对源代码的学习，可以就此止步。因为对我们来说，没有太富余的时间把每个遇到的库都从头到尾研究一番，只要搞明白如何使用好 Rust 生态中可用的库来构建想构建的系统，就足够了。  

但有些时候，我们希望能够更深入一步。推荐“主题阅读”或者说“情境阅读”，就是:**围绕着一个特定的使用场景，以这个场景的主流程为脉络，搞明白实现原理。**  

在围绕着情景读代码时，建议你使用绘图工具，边读边记录（我用的 excalidraw），非常有助于你理解代码脉络，不至于在无穷无尽的跳转中迷失了方向。

## 小结
注意阅读的顺序：
- 从大纲开始，先了解目标代码能干什么，怎么用；
- 然后学习它的主要 trait；之后是数据结构，搞明白后再看看示例代码（examples）或者集成测试（tests），自己写一些示例代码；
- 最后，围绕着自己感兴趣的情景深入阅读。并不是所有的代码都需要走到最后一步，你要根据自己的需要和精力量力而行。